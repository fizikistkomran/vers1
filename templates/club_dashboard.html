{% extends "base.html" %}
{% block title %}{{ club.name }} · Kulüp Paneli{% endblock %}
{% block content %}

<div class="hero card" style="position:relative;border-radius:16px;overflow:hidden;border:1px solid var(--glass-stroke)">
  <div style="height:180px;background:#222 url('{{ club.banner_url or "" }}') center/cover no-repeat"></div>
  <div style="padding:16px">
    <h2 style="margin:0">{{ club.name }}</h2>
    <div class="meta sub">Kulüp #{{ club.id }}</div>
  </div>
</div>

<div class="tabs" style="display:flex;gap:16px;flex-wrap:wrap;margin:16px 0">
  <a class="chip" href="{{ url_for('club_members', club_id=club.id) }}">Üyeler & Roller</a>
  <a class="chip" href="{{ url_for('club_analytics', club_id=club.id) }}">Analitik</a>
  <a class="chip" href="{{ url_for('club_graph', club_id=club.id) }}">Grafik (tam ekran)</a>
</div>

{% if owner %}
  <h3 class="section-title">Topluluk Ağı</h3>
  <p class="muted">Bağ oluşturmak için aşağıdaki listeden “Bağlan” de; karşı taraf kabul ederse grafikte kenar oluşur.</p>
  <iframe
    src="{{ url_for('club_graph', club_id=club.id) }}"
    style="width:100%;height:560px;border:1px solid var(--glass-stroke);border-radius:12px;background:#0e0f13"
    loading="lazy" referrerpolicy="no-referrer">
  </iframe>
{% else %}
  <div class="empty list">Grafiği sadece admin-like profiller görebilir.</div>
{% endif %}

<h3 class="section-title" style="margin-top:20px">Üyeler</h3>
<table class="list" style="width:100%;border-collapse:collapse">
  <thead>
    <tr>
      <th style="text-align:left;padding:8px 6px">Üye</th>
      <th style="text-align:left;padding:8px 6px">Rol</th>
      <th style="text-align:left;padding:8px 6px">Bağlantı</th>
    </tr>
  </thead>
  <tbody>
    {% for m in members %}
    <tr>
      <td style="padding:8px 6px;display:flex;gap:8px;align-items:center">
        <img src="{{ m.avatar_url or '/static/avatar-placeholder.png' }}" alt="" style="width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid #333">
        {{ m.name }}
      </td>
      <td style="padding:8px 6px"><code>{{ m.role }}</code></td>
      <td style="padding:8px 6px">
        {% if m.id == user.id %}
          <em>Ben</em>
        {% else %}
          {# Durum göstergesi (server tarafı hesaplayıp m.edge_status ve m.requested_by ekleyebilir; yoksa sadece "Bağlan" görünür) #}
          {% if m.edge_status == 'accepted' %}
            <span class="chip">Bağlı</span>
          {% elif m.edge_status == 'pending' and m.requested_by == user.id %}
            <form method="post" action="{{ url_for('connect_cancel', club_id=club.id) }}" style="display:inline">
              <input type="hidden" name="target_user_id" value="{{ m.id }}">
              <button class="btn-badge" style="opacity:.85">İsteği İptal Et</button>
            </form>
          {% elif m.edge_status == 'pending' and m.requested_by != user.id %}
            {# Karşıdan geleni kabul/ret #}
            <form method="post" action="{{ url_for('connect_respond', club_id=club.id) }}" style="display:inline;margin-right:6px">
              <input type="hidden" name="src_user_id" value="{{ [user.id, m.id]|min }}">
              <input type="hidden" name="dst_user_id" value="{{ [user.id, m.id]|max }}">
              <input type="hidden" name="action" value="accept">
              <button class="btn-badge">Kabul</button>
            </form>
            <form method="post" action="{{ url_for('connect_respond', club_id=club.id) }}" style="display:inline">
              <input type="hidden" name="src_user_id" value="{{ [user.id, m.id]|min }}">
              <input type="hidden" name="dst_user_id" value="{{ [user.id, m.id]|max }}">
              <input type="hidden" name="action" value="decline">
              <button class="btn-badge" style="opacity:.8">Reddet</button>
            </form>
          {% else %}
            <form method="post" action="{{ url_for('connect_request', club_id=club.id) }}" style="display:inline">
              <input type="hidden" name="target_user_id" value="{{ m.id }}">
              <button class="btn-badge">Bağlan</button>
            </form>
          {% endif %}
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{% if events %}
  <h3 class="section-title" style="margin-top:20px">Etkinlikler</h3>
  <div class="grid">
    {% for e in events %}
      <a class="card" href="{{ url_for('event_analytics', event_id=e.id) }}">
        <div class="club">{{ club.name }}</div>
        {% if (e.category or 'event') == 'meeting' %}<span class="chip">Toplantı</span>{% endif %}
        <div style="font-size:20px">{{ e.title }}</div>
        <div class="meta">{{ (e.starts_at or e.created_at)|ts }}</div>
      </a>
    {% endfor %}
  </div>
{% endif %}

{% endblock %}

